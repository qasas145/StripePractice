<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ø´ØªØ±Ø§Ùƒ Ø³Ù†ÙˆÙŠ Ù…Ø¹ Proration</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="email"],
        input[type="text"],
        input[type="date"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        #card-element {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }

        .info-box {
            background: #f0f4ff;
            border-right: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #666;
            font-size: 14px;
        }

        .info-value {
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .highlight {
            color: #667eea;
            font-size: 18px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
            font-size: 14px;
            line-height: 1.6;
        }

        #status.show {
            display: block;
        }

        #status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        #status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        #status.loading {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .calculation-result {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .calculation-result.show {
            display: block;
        }

        .result-title {
            font-size: 18px;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .optional-tag {
            background: #ffd700;
            color: #333;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ Ø§Ø´ØªØ±Ø§Ùƒ Ø³Ù†ÙˆÙŠ Ù…Ø¹ Proration</h1>
        <p class="subtitle">Ø§Ø¯ÙØ¹ ÙÙ‚Ø· Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ù†Ø©ØŒ Ø«Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>

        <form id="annual-subscription-form">
            <div class="form-group">
                <label for="email">ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input id="email" type="email" placeholder="user@example.com" required />
            </div>

            <div class="form-group">
                <label for="priceId">ğŸ·ï¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¹Ø± (Price ID)</label>
                <input id="priceId" type="text" placeholder="price_..." required />
                <div class="help-text">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø¹Ø±Ø§Ù‹ Ø³Ù†ÙˆÙŠØ§Ù‹ (yearly Ø£Ùˆ 12 Ø´Ù‡Ø±)</div>
            </div>

            <div class="form-group">
                <label for="annualAmount">ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±)</label>
                <input id="annualAmount" type="number" placeholder="1200" min="1" step="0.01" required />
                <div class="help-text">Ù…Ø«Ø§Ù„: 1200 Ø¯ÙˆÙ„Ø§Ø± = Ø§Ø´ØªØ±Ø§Ùƒ Ø³Ù†ÙˆÙŠ</div>
            </div>

            <div class="form-group">
                <label for="subscriptionStartDate">ğŸ“… ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                <input id="subscriptionStartDate" type="date" required />
                <div class="help-text">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
            </div>

            <div class="form-group">
                <label for="futureBillingDate">
                    <span class="optional-tag">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span>
                    ğŸ—“ï¸ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙÙˆØªØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                </label>
                <input id="futureBillingDate" type="date" />
                <div class="help-text">Ø¥Ø°Ø§ ØªØ±ÙƒØªÙ‡ ÙØ§Ø±ØºØ§Ù‹ØŒ Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø³Ù†Ø© Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© + Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</div>
            </div>

            <div class="form-group">
                <label for="card">ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <div id="card-element"></div>
            </div>

            <button type="button" id="calculate-btn">ğŸ§® Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</button>

            <div id="calculation-result" class="calculation-result">
                <div class="result-title">ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</div>
                <div class="info-box">
                    <div class="info-item">
                        <span class="info-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ Ø§Ù„ÙƒØ§Ù…Ù„</span>
                        <span class="info-value" id="calc-annual">$0.00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø§Ù„Ø¢Ù† (Prorated)</span>
                        <span class="info-value highlight" id="calc-prorated">$0.00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span>
                        <span class="info-value" id="calc-days">0 ÙŠÙˆÙ…</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ÙÙˆØªØ±Ø©</span>
                        <span class="info-value" id="calc-months">0 Ø´Ù‡Ø±</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</span>
                        <span class="info-value" id="calc-extra-days">0 ÙŠÙˆÙ…</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„</span>
                        <span class="info-value" id="calc-billing-date">--</span>
                    </div>
                </div>
            </div>

            <button type="submit" id="submit-btn">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø¯ÙØ¹</button>
        </form>

        <div id="status"></div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const form = document.getElementById('annual-subscription-form');
        const submitBtn = document.getElementById('submit-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        const calculationResult = document.getElementById('calculation-result');

        let stripe;
        let card;

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…
        document.getElementById('subscriptionStartDate').valueAsDate = new Date();

        async function loadStripe() {
            try {
                const res = await fetch('/api/config/stripe-publishable-key');
                if (!res.ok) {
                    throw new Error('Could not load publishable key');
                }
                const data = await res.json();
                stripe = Stripe(data.publishableKey);
                const elements = stripe.elements();
                card = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#32325d',
                            fontFamily: '"Segoe UI", sans-serif',
                            '::placeholder': {
                                color: '#aab7c4'
                            }
                        }
                    }
                });
                card.mount('#card-element');
            } catch (err) {
                setStatus(err.message, 'error');
            }
        }

        function setStatus(message, type = 'loading') {
            statusEl.textContent = message;
            statusEl.className = `show ${type}`;
        }

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            calculateBtn.disabled = isLoading;
            submitBtn.textContent = isLoading ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...' : 'âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø¯ÙØ¹';
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚
        calculateBtn.addEventListener('click', async () => {
            const annualAmount = parseFloat(document.getElementById('annualAmount').value);
            const startDate = document.getElementById('subscriptionStartDate').value;
            const futureBillingDate = document.getElementById('futureBillingDate').value;

            if (!annualAmount || !startDate) {
                setStatus('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'error');
                return;
            }

            try {
                setLoading(true);
                setStatus('ğŸ§® Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...', 'loading');

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚Ø³Ù‘Ù…
                const annualAmountInCents = Math.round(annualAmount * 100);
                const calcRes = await fetch(
                    `/api/stripe/calculate-prorated?annualPrice=${annualAmountInCents}&startDate=${startDate}`
                );

                if (!calcRes.ok) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº');
                }

                const calcData = await calcRes.json();
                
                // Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙÙˆØªØ±Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©
                const startDateObj = new Date(startDate);
                const anniversaryDate = new Date(startDateObj);
                anniversaryDate.setFullYear(anniversaryDate.getFullYear() + 1);
                
                const finalBillingDate = futureBillingDate 
                    ? new Date(futureBillingDate) 
                    : anniversaryDate;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
                finalBillingDate.setDate(finalBillingDate.getDate() + (calcData.extraDays || 0));

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                document.getElementById('calc-annual').textContent = `$${annualAmount.toFixed(2)}`;
                document.getElementById('calc-prorated').textContent = `$${calcData.proratedAmount.toFixed(2)}`;
                document.getElementById('calc-days').textContent = `${calcData.daysRemaining} ÙŠÙˆÙ…`;
                document.getElementById('calc-months').textContent = `${calcData.billableMonths} Ø´Ù‡Ø±`;
                document.getElementById('calc-extra-days').textContent = `${calcData.extraDays} ÙŠÙˆÙ…`;
                document.getElementById('calc-billing-date').textContent = finalBillingDate.toLocaleDateString('ar-EG');

                calculationResult.classList.add('show');
                setStatus('âœ… ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'success');
            } catch (err) {
                setStatus(`âŒ Ø®Ø·Ø£: ${err.message}`, 'error');
            } finally {
                setLoading(false);
            }
        });

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);
            setStatus('ğŸš€ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ...', 'loading');

            try {
                const email = document.getElementById('email').value.trim();
                const priceId = document.getElementById('priceId').value.trim();
                const annualAmount = parseFloat(document.getElementById('annualAmount').value);
                const subscriptionStartDate = document.getElementById('subscriptionStartDate').value;
                const futureBillingDate = document.getElementById('futureBillingDate').value;

                // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
                const pmResult = await stripe.createPaymentMethod({
                    type: 'card',
                    card,
                    billing_details: { email }
                });

                if (pmResult.error) {
                    throw new Error(pmResult.error.message || 'Ø®Ø·Ø£ ÙÙŠ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹');
                }

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù€ API
                const body = {
                    email,
                    priceId,
                    paymentMethodId: pmResult.paymentMethod.id,
                    annualPriceAmount: Math.round(annualAmount * 100),
                    subscriptionStartDate: subscriptionStartDate || null,
                    futureBillingStartDate: futureBillingDate || null
                };

                const subRes = await fetch('/api/stripe/subscription/annual-with-proration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const subData = await subRes.json();
                console.log('Response:', subData);

                if (!subRes.ok) {
                    throw new Error(subData?.error || subData?.Error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ');
                }

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                const successMessage = `
âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!

ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${subData.email}
ğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${subData.stripeSubscriptionId}
ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: ${subData.stripeSubscriptionStatus}

ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø¢Ù†: $${subData.proratedAmount.toFixed(2)}
ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ Ø§Ù„ÙƒØ§Ù…Ù„: $${subData.annualAmount.toFixed(2)}
ğŸ“… ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${subData.subscriptionStartDate}
ğŸ—“ï¸ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ù„ÙŠ: ${subData.nextRenewalDate}

${subData.message}
                `.trim();

                setStatus(successMessage, 'success');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                form.reset();
                card.clear();
                calculationResult.classList.remove('show');
                document.getElementById('subscriptionStartDate').valueAsDate = new Date();

            } catch (err) {
                setStatus(`âŒ Ø®Ø·Ø£: ${err.message}`, 'error');
            } finally {
                setLoading(false);
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Stripe Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        loadStripe();
    </script>
</body>
</html>
